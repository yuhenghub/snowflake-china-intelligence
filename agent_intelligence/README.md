# Agent Intelligence V3.2 (æ™ºèƒ½åˆ†æåŠ©æ‰‹)

> Snowflake China Intelligence çš„æ ¸å¿ƒç»„ä»¶ - ä¸º Snowflake ä¸­å›½åŒºæä¾›è‡ªç„¶è¯­è¨€æ•°æ®åˆ†æèƒ½åŠ›
> 
> **Version 3.2** - Agent Chat + Data Insights åŒæ¨¡å—å¤šè½®å¯¹è¯ï¼Œä¸ªæ€§åŒ–é—®å€™

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Snowflake China Intelligence V3.2                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Streamlit in Snowflake (SiS)                      â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚            Personalized Greeting (First Name)                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚        "Good morning, {FirstName}! What insights..."         â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚     ğŸ¤– Agent Chat       â”‚  â”‚       ğŸ“ˆ Data Insights          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    (å·¥å…·è°ƒç”¨å¤šè½®)         â”‚  â”‚   (SQL+æ•°æ®+æ´å¯Ÿ å¤šè½® Deep Dive) â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ execute_sql       â”‚  â”‚  â”‚  â”‚ Auto SQL Generation       â”‚  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ get_table_info    â”‚  â”‚  â”‚  â”‚ Query Execution           â”‚  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ AI Insights Generation    â”‚  â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ Follow-up Deep Dive       â”‚  â”‚   â”‚    â”‚
â”‚  â”‚               â”‚               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚    â”‚
â”‚  â”‚               â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚               â”‚                               â”‚                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚              Context Manager (ç‹¬ç«‹ä¸Šä¸‹æ–‡ç®¡ç†)                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Agent History â”‚  â”‚Insights Hist. â”‚  â”‚  Semantic Model   â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  (ç‹¬ç«‹å­˜å‚¨)    â”‚  â”‚  (ç‹¬ç«‹å­˜å‚¨)    â”‚  â”‚   (å…±äº«)          â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                 â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Snowflake Data Layer                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                   Chat History Schema                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ AGENT_CHAT_SESSIONS  â”‚  â”‚    INSIGHTS_SESSIONS          â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ AGENT_CHAT_MESSAGES  â”‚  â”‚    INSIGHTS_MESSAGES          â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  (Agentä¸“ç”¨)          â”‚  â”‚    (Insightsä¸“ç”¨)             â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ å¤šè½®å¯¹è¯å®ç°åŸç†

### æ ¸å¿ƒè®¾è®¡

å¤šè½®å¯¹è¯çš„å…³é”®åœ¨äº**å¦‚ä½•å°†å†å²å¯¹è¯æœ‰æ•ˆåœ°ä¼ é€’ç»™ LLM**ï¼ŒåŒæ—¶æ§åˆ¶ token æ¶ˆè€—ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Multi-turn Conversation Flow                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  User Question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                                                       â”‚              â”‚
â”‚                                                       â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  format_history_for_prompt()                 â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   Session State                                              â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚ messages: [                                          â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   {role: "user", content: "é”€å”®é¢æ˜¯å¤šå°‘?"},           â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   {role: "assistant", content: "æŸ¥è¯¢ç»“æœ..."},        â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   {role: "user", content: "æŒ‰æœˆä»½åˆ†ç»„"},              â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   {role: "assistant", content: "æœˆåº¦æ•°æ®..."},        â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   ...                                                â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ ]                                                    â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                         â”‚                                    â”‚   â”‚
â”‚  â”‚                         â–¼                                    â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚  1. å–æœ€è¿‘ N æ¡æ¶ˆæ¯ (MAX_HISTORY_MESSAGES=20)         â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  2. ä»æœ€æ–°åˆ°æœ€æ—§éå†ï¼Œç´¯è®¡å­—ç¬¦æ•°                        â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  3. è¶…è¿‡ MAX_HISTORY_CHARS=8000 æ—¶åœæ­¢                â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  4. é•¿æ¶ˆæ¯æˆªæ–­ä¸º 500 å­—ç¬¦ + "...[truncated]"          â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                   â”‚
â”‚                                 â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Final Prompt Structure                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ## Previous Conversation:                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ [User]: é”€å”®é¢æ˜¯å¤šå°‘?                                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ [Assistant]: æ ¹æ®æŸ¥è¯¢ï¼Œæ€»é”€å”®é¢ä¸º...                     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ [User]: æŒ‰æœˆä»½åˆ†ç»„                                      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ [Assistant]: æœˆåº¦é”€å”®æ•°æ®å¦‚ä¸‹...                        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ ---                                                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ [Context: Last query returned 12 rows with columns:    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  month, total_sales, order_count]                      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ [Current Question]: å“ªä¸ªæœˆé”€å”®æœ€é«˜?                     â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                   â”‚
â”‚                                 â–¼                                   â”‚
â”‚                          LLM Response                               â”‚
â”‚                                 â”‚                                   â”‚
â”‚                                 â–¼                                   â”‚
â”‚                    Save to Session + Database                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç å®ç°

```python
def format_history_for_prompt(messages: List[Dict], 
                              max_messages: int = 20,
                              max_chars: int = 8000) -> str:
    """
    æ ¼å¼åŒ–å¯¹è¯å†å²ç”¨äº Prompt
    
    ç­–ç•¥ï¼š
    1. å–æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼ˆä¼˜å…ˆä¿ç•™æœ€æ–°çš„ä¸Šä¸‹æ–‡ï¼‰
    2. ä»æ–°åˆ°æ—§éå†ï¼Œç´¯è®¡å­—ç¬¦æ•°
    3. è¶…è¿‡å­—ç¬¦é™åˆ¶æ—¶åœæ­¢ï¼ˆé¿å…è¶…å‡º token é™åˆ¶ï¼‰
    4. é•¿æ¶ˆæ¯è‡ªåŠ¨æˆªæ–­
    """
    if not messages:
        return ""
    
    # å–æœ€è¿‘ N æ¡
    recent_messages = messages[-max_messages:]
    
    formatted_parts = []
    total_chars = 0
    
    # ä»æœ€æ–°åˆ°æœ€æ—§éå†ï¼ˆä¿è¯æœ€æ–°çš„å¯¹è¯ä¸€å®šä¼šè¢«åŒ…å«ï¼‰
    for msg in reversed(recent_messages):
        role = "User" if msg["role"] == "user" else "Assistant"
        content = msg.get("content", "")
        
        # æˆªæ–­è¿‡é•¿æ¶ˆæ¯
        if len(content) > 500:
            content = content[:500] + "...[truncated]"
        
        part = f"[{role}]: {content}"
        
        # æ£€æŸ¥æ˜¯å¦è¶…å‡ºå­—ç¬¦é™åˆ¶
        if total_chars + len(part) > max_chars:
            break
        
        formatted_parts.insert(0, part)  # æ’å…¥åˆ°å¼€å¤´ä¿æŒé¡ºåº
        total_chars += len(part)
    
    if formatted_parts:
        return "## Previous Conversation:\n" + "\n\n".join(formatted_parts) + "\n\n---\n"
    return ""
```

### æŒä¹…åŒ–å­˜å‚¨

å¯¹è¯å†å²å­˜å‚¨åœ¨ **åŒä¸€ Schema ä¸‹çš„ä¸åŒè¡¨**ï¼ŒAgent Chat å’Œ Data Insights ç‹¬ç«‹ç®¡ç†ï¼š

```sql
-- ========== Agent Chat å­˜å‚¨ ==========
CREATE TABLE AGENT_CHAT_SESSIONS (
    session_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(255),
    title VARCHAR(500),
    created_at TIMESTAMP_NTZ,
    updated_at TIMESTAMP_NTZ,
    semantic_model_name VARCHAR(255),
    message_count INTEGER
);

CREATE TABLE AGENT_CHAT_MESSAGES (
    message_id VARCHAR(36) PRIMARY KEY,
    session_id VARCHAR(36),
    role VARCHAR(20),           -- user / assistant
    content TEXT,
    tool_info TEXT,             -- å·¥å…·è°ƒç”¨ JSON
    query_result TEXT,          -- æŸ¥è¯¢ç»“æœ JSON
    created_at TIMESTAMP_NTZ
);

-- ========== Data Insights å­˜å‚¨ ==========
CREATE TABLE INSIGHTS_SESSIONS (
    session_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(255),
    title VARCHAR(500),
    created_at TIMESTAMP_NTZ,
    updated_at TIMESTAMP_NTZ,
    semantic_model_name VARCHAR(255),
    message_count INTEGER
);

CREATE TABLE INSIGHTS_MESSAGES (
    message_id VARCHAR(36) PRIMARY KEY,
    session_id VARCHAR(36),
    role VARCHAR(20),
    content TEXT,
    sql_query TEXT,             -- æ‰§è¡Œçš„ SQL
    query_result TEXT,          -- æ•°æ®ç»“æœ JSON
    insights TEXT,              -- AI æ´å¯Ÿå†…å®¹
    created_at TIMESTAMP_NTZ
);
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `cortex_agent_sis_v2.py` | ä¸»åº”ç”¨æ–‡ä»¶ (Streamlit in Snowflake) V3 |
| `environment.yml` | SiS ä¾èµ–é…ç½® |
| `setup_qwen_udf.sql` | å¤–éƒ¨ API UDF éƒ¨ç½²è„šæœ¬ |
| `RELEASE_NOTES.md` | ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ |

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### ä½¿ç”¨ Snow CLI éƒ¨ç½²

```bash
# 1. ä¸Šä¼ æ–‡ä»¶åˆ° Stage
snow stage copy cortex_agent_sis_v2.py @YOUR_DB.YOUR_SCHEMA.STAGE/ --connection your_conn --overwrite
snow stage copy environment.yml @YOUR_DB.YOUR_SCHEMA.STAGE/ --connection your_conn --overwrite

# 2. åˆ›å»º Streamlit åº”ç”¨
snow sql -q "
CREATE OR REPLACE STREAMLIT YOUR_DB.YOUR_SCHEMA.CHINA_INTELLIGENCE_V3
ROOT_LOCATION = '@YOUR_DB.YOUR_SCHEMA.STAGE'
MAIN_FILE = 'cortex_agent_sis_v2.py'
TITLE = 'Snowflake China Intelligence V3'
QUERY_WAREHOUSE = YOUR_WAREHOUSE
EXTERNAL_ACCESS_INTEGRATIONS = (your_integration)
" --connection your_conn
```

### å¯ç”¨å†å²è®°å½•

æ‰“å¼€åº”ç”¨åï¼Œåœ¨ä¾§è¾¹æ  **ğŸ’¬ Conversations** åŒºåŸŸï¼š
1. é€‰æ‹©å­˜å‚¨å†å²çš„ **Database** å’Œ **Schema**
2. ç‚¹å‡» **âœ… Configure & Setup Tables**
3. ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º 4 å¼ è¡¨å¹¶æ˜¾ç¤ºå†å²ä¼šè¯åˆ—è¡¨

## ğŸ§  æ”¯æŒçš„æ¨¡å‹

| åç«¯ | æ¨¡å‹ | è¯´æ˜ |
|------|------|------|
| **External API** | qwen-max | æœ€å¼ºå¤§ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡ |
| | qwen-plus | å¹³è¡¡æ€§ä»·æ¯” |
| | qwen-turbo | å¿«é€Ÿå“åº” |
| | deepseek-chat | DeepSeek-V3 |
| | deepseek-reasoner | DeepSeek-R1 æ·±åº¦æ¨ç† |
| **SPCS** | Qwen2.5-1.5B-Instruct | ç§æœ‰åŒ–éƒ¨ç½²ï¼Œæ•°æ®ä¸å‡ºäº‘ |

## ğŸ“š V3.2 æ–°åŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **ä¸ªæ€§åŒ–é—®å€™** | æ ¹æ® First Name æ˜¾ç¤º "Good morning, John" |
| **Insights å¤šè½®å¯¹è¯** | Data Insights æ”¯æŒ Deep Diveï¼ŒåŸºäºå‰æ¬¡ç»“æœè¿½é—® |
| **ç‹¬ç«‹ä¼šè¯ç®¡ç†** | Agent Chat å’Œ Insights å„è‡ªç‹¬ç«‹çš„å†å²å­˜å‚¨ |
| **åˆ†è¡¨å­˜å‚¨** | åŒä¸€ Schema ä¸‹ 4 å¼ è¡¨ï¼šAgent (2å¼ ) + Insights (2å¼ ) |
| **ç®€åŒ–é…ç½®** | Conversations åŒºåŸŸä¸€ç«™å¼é…ç½®å†å²å­˜å‚¨ |
| **è‡ªåŠ¨åŠ è½½å†å²** | é…ç½®å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºå†å²ä¼šè¯åˆ—è¡¨ |

## âš ï¸ æ³¨æ„äº‹é¡¹

- éœ€è¦é€šä¹‰åƒé—® API Key æˆ– SPCS ç§æœ‰åŒ–æœåŠ¡
- å†å²è®°å½•åŠŸèƒ½éœ€è¦åœ¨é€‰å®š Schema ä¸­åˆ›å»ºè¡¨
- å¤šè½®å¯¹è¯é»˜è®¤ä¿ç•™æœ€è¿‘ 20 æ¡æ¶ˆæ¯ / 8000 å­—ç¬¦

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Release Notes](./RELEASE_NOTES.md) - ç‰ˆæœ¬å‘å¸ƒè¯´æ˜
- [ä¸»é¡¹ç›® README](../README.md) - Snowflake China Intelligence æ€»è§ˆ
- [SPCS ç§æœ‰åŒ–éƒ¨ç½²](../spcs_china/README.md) - ç§æœ‰åŒ– LLM æœåŠ¡éƒ¨ç½²æŒ‡å—
